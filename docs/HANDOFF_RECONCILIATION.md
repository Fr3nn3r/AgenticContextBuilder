# Handoff: Reconciliation Implementation

**Date:** 2026-01-26
**Status:** All Phases Complete (1-5)

## Summary

Implemented claim-level reconciliation as a proper pipeline stage with quality gates. The reconciliation process aggregates facts from document extractions, detects conflicts, and produces a gate report (advisory, does not block downstream processing).

## Completed Work

### Phase 1: Backend - Reconciliation Engine ✅

**New Files Created:**

| File | Purpose |
|------|---------|
| `src/context_builder/schemas/reconciliation.py` | Pydantic models: `GateStatus`, `FactConflict`, `GateThresholds`, `ReconciliationGate`, `ReconciliationReport`, `ReconciliationResult` |
| `src/context_builder/api/services/reconciliation.py` | `ReconciliationService` with conflict detection, gate evaluation, report writing |

**Files Modified:**

| File | Change |
|------|--------|
| `src/context_builder/schemas/__init__.py` | Export new reconciliation schemas |
| `src/context_builder/api/services/__init__.py` | Export `ReconciliationService`, `ReconciliationError` |
| `src/context_builder/pipeline/claim_stages/reconciliation.py` | Replaced stub with full implementation using `ReconciliationService` |

**Key Features:**
- Aggregates facts from document extractions (delegates to existing `AggregationService`)
- Detects conflicts (same fact with different values across documents)
- Evaluates quality gate with configurable thresholds:
  - PASS: No missing critical facts, no conflicts
  - WARN: ≤2 missing critical facts OR ≤2 conflicts OR tokens > 40K
  - FAIL: >2 missing critical facts OR >2 conflicts OR tokens > 60K
- Critical facts derived from `required_fields` in extraction specs (customer-configurable)
- Writes `reconciliation_report.json` to claim context directory

### Phase 2: CLI Integration ✅

**File Modified:** `src/context_builder/cli.py`

**New Command:**
```bash
python -m context_builder.cli reconcile --claim-id 65196
python -m context_builder.cli reconcile --claim-id 65196 --dry-run   # Preview JSON
python -m context_builder.cli reconcile --claim-id 65196 --run-id run_...  # Specific run
python -m context_builder.cli reconcile --claim-id 65196 -v  # Verbose
python -m context_builder.cli reconcile --claim-id 65196 -q  # Quiet
```

**Output:**
- Color-coded gate status (green=PASS, yellow=WARN, red=FAIL)
- Summary: facts count, conflicts, missing critical facts
- Conflict details
- Output file paths

## Test Results

All 4 claims in workspace tested successfully:

| Claim | Gate | Facts | Conflicts | Missing Critical |
|-------|------|-------|-----------|------------------|
| 65128 | WARN | 68 | 1 | 0 |
| 65157 | FAIL | 83 | 3 | 0 |
| 65196 | WARN | 74 | 2 | 0 |
| 65258 | WARN | 67 | 2 | 0 |

Unit tests: 1068 passed (2 pre-existing failures unrelated to this work)

## Output Files

Each claim now gets two files in `claims/{claim_id}/context/`:

1. **claim_facts.json** - Aggregated facts (existing format, now generated by reconciliation)
2. **reconciliation_report.json** - Gate status and conflict details (new)

Example `reconciliation_report.json`:
```json
{
  "schema_version": "reconciliation_v1",
  "claim_id": "65196",
  "run_id": "run_20260124_221046_7cc77c7",
  "gate": {
    "status": "warn",
    "missing_critical_facts": [],
    "conflict_count": 2,
    "provenance_coverage": 0.527,
    "estimated_tokens": 625,
    "reasons": ["2 conflicts detected"]
  },
  "conflicts": [
    {
      "fact_name": "document_date",
      "values": ["2026-01-14", "14. Januar 2026"],
      "sources": [["892e03039708"], ["9f02e29c5838"]],
      "selected_value": "2026-01-14",
      "selected_confidence": 0.9,
      "selection_reason": "highest_confidence"
    }
  ],
  "fact_count": 74,
  "critical_facts_spec": ["policy_number", "start_date", ...],
  "critical_facts_present": ["policy_number", "start_date", ...],
  "thresholds_used": {...}
}
```

## Core vs Customer-Specific

| Component | Location | Notes |
|-----------|----------|-------|
| ReconciliationService | Core (`src/`) | Generic mechanism |
| Schemas | Core (`src/`) | Generic data models |
| CLI command | Core (`src/`) | Generic tooling |
| Critical facts | Customer config | Derived from `required_fields` in extraction specs |
| Gate thresholds | Core defaults + Customer override | Optional `config/reconciliation_gate.yaml` |

No customer repo changes required - existing `required_fields` in extraction specs are used automatically.

### Phase 3: API Endpoints ✅

**Files Modified:**

| File | Change |
|------|--------|
| `src/context_builder/api/routers/claims.py` | Added `run_reconciliation` and `get_reconciliation_report` endpoints |
| `src/context_builder/api/dependencies.py` | Added `get_aggregation_service` and `get_reconciliation_service` getters |

**New Endpoints:**

```
POST /api/claims/{claim_id}/reconcile
  - Triggers reconciliation for a claim
  - Optional body: {"run_id": "..."}
  - Returns: {claim_id, success, gate_status, fact_count, conflict_count, report_path, error}

GET /api/claims/{claim_id}/reconciliation-report
  - Gets the latest reconciliation report
  - Returns reconciliation_report.json contents or null
```

### Phase 4: Run-Level Aggregation ✅

**New Schemas (in `src/context_builder/schemas/reconciliation.py`):**
- `ReconciliationClaimResult` - Per-claim result in evaluation
- `FactFrequency` - Frequency count for missing/conflicting facts
- `ReconciliationEvalSummary` - Summary statistics
- `ReconciliationRunEval` - Full run-level evaluation output

**Files Modified:**

| File | Change |
|------|--------|
| `src/context_builder/schemas/reconciliation.py` | Added run-level evaluation schemas |
| `src/context_builder/schemas/__init__.py` | Export new schemas |
| `src/context_builder/api/services/reconciliation.py` | Added `aggregate_run_evaluation()` and `write_run_evaluation()` methods |
| `src/context_builder/cli.py` | Added `reconcile-eval` CLI command |

**New CLI Command:**
```bash
python -m context_builder.cli reconcile-eval              # Aggregate all reconciliation reports
python -m context_builder.cli reconcile-eval --dry-run    # Preview without writing
python -m context_builder.cli reconcile-eval --top-n 5    # Include top 5 missing/conflicts
```

**Output File:** `eval/reconciliation_gate_eval_YYYYMMDD_HHMMSS.json`

**Example Output:**
```json
{
  "schema_version": "reconciliation_eval_v1",
  "evaluated_at": "2026-01-26T15:30:14",
  "run_id": "run_20260124_221046_7cc77c7",
  "summary": {
    "total_claims": 4,
    "passed": 0,
    "warned": 3,
    "failed": 1,
    "pass_rate": 0.0,
    "pass_rate_percent": "0.0%",
    "avg_fact_count": 73.0,
    "avg_conflicts": 2.0,
    "total_conflicts": 8
  },
  "top_missing_facts": [],
  "top_conflicts": [
    {"fact_name": "document_date", "count": 3, "claim_ids": ["65128", "65157", "65196"]}
  ],
  "results": [...]
}
```

### Phase 5: UI Components ✅

**New Files:**

| File | Purpose |
|------|---------|
| `ui/src/components/assessment/ReconciliationEvalView.tsx` | Reconciliation evaluation view component |
| `ui/src/types/index.ts` (additions) | TypeScript types for reconciliation evaluation |

**Files Modified:**

| File | Change |
|------|--------|
| `src/context_builder/api/routers/claims.py` | Added `GET /api/reconciliation/evals/latest` endpoint |
| `ui/src/api/client.ts` | Added `getLatestReconciliationEval()` API client function |
| `ui/src/components/assessment/index.ts` | Export `ReconciliationEvalView` |
| `ui/src/components/evaluation/EvaluationPage.tsx` | Added "Reconciliation" tab |

**New Features:**
- "Reconciliation" tab on Evaluation page (`/evaluation?tab=reconciliation`)
- KPI cards: total claims, pass rate, pass/warn/fail counts
- Secondary KPIs: avg facts, avg conflicts, total conflicts, avg missing critical
- Top missing facts table (facts missing across multiple claims)
- Top conflicts table (facts conflicting across multiple claims)
- Per-claim results table with gate status, filters, and links to Claim Explorer

**API Endpoint:**
```
GET /api/reconciliation/evals/latest
  - Returns the most recent reconciliation_gate_eval_*.json
  - Returns null if no evaluation exists
```

## Implementation Complete

All reconciliation features are now available:

1. **CLI Commands:**
   - `reconcile --claim-id <id>` - Reconcile a single claim
   - `reconcile-eval` - Aggregate all reconciliation reports into evaluation

2. **API Endpoints:**
   - `POST /api/claims/{claim_id}/reconcile` - Trigger reconciliation
   - `GET /api/claims/{claim_id}/reconciliation-report` - Get claim's report
   - `GET /api/reconciliation/evals/latest` - Get latest evaluation

3. **UI:**
   - Evaluation page → Reconciliation tab

## Related Documents

- `docs/RECONCILIATION_IMPLEMENTATION_PLAN.md` - Full implementation plan
- `docs/EVALUATION_DASHBOARD_PLAN.md` - Original dashboard plan

## Quick Start

Test the implementation:
```bash
# Run reconciliation for a single claim
python -m context_builder.cli reconcile --claim-id 65196

# Run reconciliation for all claims (example)
for id in 65128 65157 65196 65258; do
  python -m context_builder.cli reconcile --claim-id $id -q
done

# Generate run-level evaluation
python -m context_builder.cli reconcile-eval

# Check output files
cat workspaces/nsa/claims/65196/context/reconciliation_report.json
cat workspaces/nsa/eval/reconciliation_gate_eval_*.json

# View in UI: http://localhost:5173/evaluation?tab=reconciliation
```
