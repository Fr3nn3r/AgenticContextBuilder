# Handoff: Reconciliation Implementation

**Date:** 2026-01-26
**Status:** Phase 1-3 Complete, Phase 4-5 Pending

## Summary

Implemented claim-level reconciliation as a proper pipeline stage with quality gates. The reconciliation process aggregates facts from document extractions, detects conflicts, and produces a gate report (advisory, does not block downstream processing).

## Completed Work

### Phase 1: Backend - Reconciliation Engine ✅

**New Files Created:**

| File | Purpose |
|------|---------|
| `src/context_builder/schemas/reconciliation.py` | Pydantic models: `GateStatus`, `FactConflict`, `GateThresholds`, `ReconciliationGate`, `ReconciliationReport`, `ReconciliationResult` |
| `src/context_builder/api/services/reconciliation.py` | `ReconciliationService` with conflict detection, gate evaluation, report writing |

**Files Modified:**

| File | Change |
|------|--------|
| `src/context_builder/schemas/__init__.py` | Export new reconciliation schemas |
| `src/context_builder/api/services/__init__.py` | Export `ReconciliationService`, `ReconciliationError` |
| `src/context_builder/pipeline/claim_stages/reconciliation.py` | Replaced stub with full implementation using `ReconciliationService` |

**Key Features:**
- Aggregates facts from document extractions (delegates to existing `AggregationService`)
- Detects conflicts (same fact with different values across documents)
- Evaluates quality gate with configurable thresholds:
  - PASS: No missing critical facts, no conflicts
  - WARN: ≤2 missing critical facts OR ≤2 conflicts OR tokens > 40K
  - FAIL: >2 missing critical facts OR >2 conflicts OR tokens > 60K
- Critical facts derived from `required_fields` in extraction specs (customer-configurable)
- Writes `reconciliation_report.json` to claim context directory

### Phase 2: CLI Integration ✅

**File Modified:** `src/context_builder/cli.py`

**New Command:**
```bash
python -m context_builder.cli reconcile --claim-id 65196
python -m context_builder.cli reconcile --claim-id 65196 --dry-run   # Preview JSON
python -m context_builder.cli reconcile --claim-id 65196 --run-id run_...  # Specific run
python -m context_builder.cli reconcile --claim-id 65196 -v  # Verbose
python -m context_builder.cli reconcile --claim-id 65196 -q  # Quiet
```

**Output:**
- Color-coded gate status (green=PASS, yellow=WARN, red=FAIL)
- Summary: facts count, conflicts, missing critical facts
- Conflict details
- Output file paths

## Test Results

All 4 claims in workspace tested successfully:

| Claim | Gate | Facts | Conflicts | Missing Critical |
|-------|------|-------|-----------|------------------|
| 65128 | WARN | 68 | 1 | 0 |
| 65157 | FAIL | 83 | 3 | 0 |
| 65196 | WARN | 74 | 2 | 0 |
| 65258 | WARN | 67 | 2 | 0 |

Unit tests: 1068 passed (2 pre-existing failures unrelated to this work)

## Output Files

Each claim now gets two files in `claims/{claim_id}/context/`:

1. **claim_facts.json** - Aggregated facts (existing format, now generated by reconciliation)
2. **reconciliation_report.json** - Gate status and conflict details (new)

Example `reconciliation_report.json`:
```json
{
  "schema_version": "reconciliation_v1",
  "claim_id": "65196",
  "run_id": "run_20260124_221046_7cc77c7",
  "gate": {
    "status": "warn",
    "missing_critical_facts": [],
    "conflict_count": 2,
    "provenance_coverage": 0.527,
    "estimated_tokens": 625,
    "reasons": ["2 conflicts detected"]
  },
  "conflicts": [
    {
      "fact_name": "document_date",
      "values": ["2026-01-14", "14. Januar 2026"],
      "sources": [["892e03039708"], ["9f02e29c5838"]],
      "selected_value": "2026-01-14",
      "selected_confidence": 0.9,
      "selection_reason": "highest_confidence"
    }
  ],
  "fact_count": 74,
  "critical_facts_spec": ["policy_number", "start_date", ...],
  "critical_facts_present": ["policy_number", "start_date", ...],
  "thresholds_used": {...}
}
```

## Core vs Customer-Specific

| Component | Location | Notes |
|-----------|----------|-------|
| ReconciliationService | Core (`src/`) | Generic mechanism |
| Schemas | Core (`src/`) | Generic data models |
| CLI command | Core (`src/`) | Generic tooling |
| Critical facts | Customer config | Derived from `required_fields` in extraction specs |
| Gate thresholds | Core defaults + Customer override | Optional `config/reconciliation_gate.yaml` |

No customer repo changes required - existing `required_fields` in extraction specs are used automatically.

### Phase 3: API Endpoints ✅

**Files Modified:**

| File | Change |
|------|--------|
| `src/context_builder/api/routers/claims.py` | Added `run_reconciliation` and `get_reconciliation_report` endpoints |
| `src/context_builder/api/dependencies.py` | Added `get_aggregation_service` and `get_reconciliation_service` getters |

**New Endpoints:**

```
POST /api/claims/{claim_id}/reconcile
  - Triggers reconciliation for a claim
  - Optional body: {"run_id": "..."}
  - Returns: {claim_id, success, gate_status, fact_count, conflict_count, report_path, error}

GET /api/claims/{claim_id}/reconciliation-report
  - Gets the latest reconciliation report
  - Returns reconciliation_report.json contents or null
```

## Remaining Work

### Phase 4: Run-Level Aggregation

Create aggregation script to produce `eval/reconciliation_gate_eval.json` for dashboard:
- Aggregate all `reconciliation_report.json` files from a run
- Summary: pass/warn/fail counts, top missing facts, top conflicts

### Phase 5: UI Components

Add to Evaluation page:
- Claim Reconciliation Gate section
- KPI cards: pass rate, avg conflicts, avg missing critical
- Tables: problem claims, top missing facts, top conflicts

## Related Documents

- `docs/RECONCILIATION_IMPLEMENTATION_PLAN.md` - Full implementation plan
- `docs/EVALUATION_DASHBOARD_PLAN.md` - Original dashboard plan

## Quick Start

Test the implementation:
```bash
# Run reconciliation for a claim
python -m context_builder.cli reconcile --claim-id 65196

# Preview without writing
python -m context_builder.cli reconcile --claim-id 65196 --dry-run

# Check output
cat workspaces/nsa/claims/65196/context/reconciliation_report.json
```
